//
// init_libx.cpp for init_libx in /home/hure_s/tek2/rendu/cpp_nibbler/libx
// 
// Made by simon hure
// Login   <hure_s@epitech.net>
// 
// Started on  Thu Apr  2 10:16:31 2015 simon hure
// Last update Thu Apr  2 20:53:49 2015 simon hure
//

#include	"libx.hh"

extern "C" IDisplay *create_t(int const &x, int const &y)
{
  (void) x;
  (void) y;
  return (new Libx(x, y));
}

Libx::Libx(int const &x, int const &y)
{
  int	newx, newy;

  newx = x * 20;
  newy = y * 20;
  _me = XOpenDisplay(NULL);
  _win = XCreateSimpleWindow(_me, RootWindow(_me, 0), 1, 1, newx, newy, 0, BlackPixel(_me, 0), BlackPixel(_me, 0));
  _screen_num = DefaultScreen(_me);
  XSelectInput(_me, _win, ExposureMask | KeyPressMask | ButtonPressMask | StructureNotifyMask);
  XMapWindow(_me, _win);
  _gc = XCreateGC(_me, _win, 0, NULL);
  XStoreName(_me, _win, "Nibbler");
  _cmap = DefaultColormap(_me, 0);
  _xcolor.red = 32000;
  _xcolor.flags = DoRed;
  XAllocColor(_me, _cmap, &_xcolor);

}

Libx::~Libx()
{

}

void	Libx::win_quit()
{

}

t_move	Libx::move()
{
  XEvent	rep;
  

  usleep(300000);     
  XSync(_me, 0);
  XNextEvent(_me, &rep);
  
  switch (rep.type)
    {
      
    case KeyPress:
      if (XLookupKeysym(&rep.xkey, 0) == XK_Escape)
	return (ESC);
      else if (XLookupKeysym(&rep.xkey, 0) == XK_Up)
	return (UP);
      else if (XLookupKeysym(&rep.xkey, 0) == XK_Down)
	return (DOWN);
      else if (XLookupKeysym(&rep.xkey, 0) == XK_Left)
	return (LEFT);
      else if (XLookupKeysym(&rep.xkey, 0) == XK_Right)
	return (RIGHT);
      break;
    }
  rep.type = KeyPress;
  XSendEvent(_me, _win, 0, 0, &rep);
  return (NONE);
  
  
  //}
       // XClientMessageEvent dummyEvent;
      //  memset(&dummyEvent, 0, sizeof(XClientMessageEvent));
      //  dummyEvent.type = ClientMessage;
      //  dummyEvent.window = _win;
      //  dummyEvent.format = 0;
       
      //  XFlush(_me);
      //  return(NONE);
      // /
       // return (NONE);
      //}
}

void	Libx::print_snake(t_snake const elem)
{
  XDrawRectangle(_me, _win, _gc, elem.x * 20, elem.y * 20, 10, 10);
  XFillRectangle(_me, _win, _gc, elem.x * 20, elem.y * 20, 10, 10);
}

void	Libx::display(std::list<t_snake> snake, const t_food food)
{
  XClearWindow(_me, _win);
  XSetForeground(_me, _gc, WhitePixel(_me, _screen_num));
  XSetFillStyle(_me, _gc, FillSolid);
  for_each(snake.begin(), snake.end(), bind1st(std::mem_fun(&Libx::print_snake), this));
  XDrawRectangle(_me, _win, _gc, snake.begin()->x * 20 , snake.begin()->y * 20, 10, 10);
  XFillRectangle(_me, _win, _gc, snake.begin()->x * 20 , snake.begin()->y * 20, 10, 10);
  //DRAW FOOD 
  XSetForeground(_me, _gc, _xcolor.pixel);
  XSetFillStyle(_me, _gc, FillSolid);
  XDrawRectangle(_me, _win, _gc, food.x * 20 , food.y * 20, 10, 10);
  XFillRectangle(_me, _win, _gc, food.x * 20 , food.y * 20, 10, 10);
  XFlush(_me);
}
